{% extends 'layouts/base.html' %}

{% block title %}Child Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4 bg-light">
    <div class="row justify-content-center">
        <div class="col-lg-8 col-md-10">
            <div class="card shadow-lg border-0 rounded-4 mb-4">
                <div class="card-body p-5 text-center">
                    <label for="profile-picture-upload" style="cursor: pointer;">
                        <img id="profile-picture-preview" src="{{ child.profile_picture_url or 'https://via.placeholder.com/150' }}" alt="Child Profile" class="rounded-circle mb-3 border border-3 border-success p-1" style="object-fit: cover; width: 150px; height: 150px;">
                    </label>
                    <input type="file" id="profile-picture-upload" accept="image/*" class="d-none">
                    <h1 class="display-4 fw-bold text-success">{{ child.name }}</h1>
                    <p class="lead text-muted">Your location is being shared with your parent.</p>
                </div>
            </div>

            <div class="card shadow-lg border-0 rounded-4 mb-4">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-route fa-2x text-primary me-3"></i>
                        <h5 class="mb-0 fw-bold text-primary">Today's Activity</h5>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%;" id="steps-progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="10000"></div>
                    </div>
                    <p class="text-center mt-2 mb-0" id="step-count">0 steps</p>
                </div>
            </div>

            <div class="card shadow-lg border-0 rounded-4 mb-4">
                <div class="card-body p-4 bg-warning">
                    <div class="d-flex align-items-center text-white">
                        <i class="fas fa-trophy fa-2x me-3"></i>
                        <h5 class="mb-0 fw-bold">Achievements</h5>
                    </div>
                    <p class="text-white mb-0 mt-2" id="achievement-text">No new badges yet.</p>
                </div>
            </div>
            
            <div class="card shadow-lg border-0 rounded-4 mb-4">
                <div class="card-body p-4 text-center">
                    <h5 class="fw-bold">Battery & Status</h5>
                    <div class="d-flex justify-content-around align-items-center mt-3">
                        <div>
                            <i class="fas fa-battery-half fa-3x text-success" id="battery-icon"></i>
                            <p class="mt-2 mb-0 fw-bold" id="battery-level">N/A</p>
                        </div>
                        <div>
                            <i class="fas fa-map-marker-alt fa-3x text-primary"></i>
                            <p class="mt-2 mb-0 fw-bold">Location: <span id="last-seen">N/A</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="geolocation-status" class="alert d-none mt-3" role="alert"></div>

            <div class="text-center mt-5">
                <a href="{{ url_for('main.logout') }}" class="btn btn-danger btn-lg rounded-pill px-5 shadow">Logout</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const lastSeenEl = document.getElementById('last-seen');
        const batteryLevelEl = document.getElementById('battery-level');
        const batteryIconEl = document.getElementById('battery-icon');
        const geolocationStatusEl = document.getElementById('geolocation-status');
        const stepsProgressEl = document.getElementById('steps-progress');
        const achievementTextEl = document.getElementById('achievement-text');
        const stepCountEl = document.getElementById('step-count');
        const profilePictureUpload = document.getElementById('profile-picture-upload');
        const profilePicturePreview = document.getElementById('profile-picture-preview');
        const childId = '{{ child.id }}';

        let lastPosition = null;
        let totalSteps = 0;

        function updateBatteryIcon(level) {
            const battery = level ? parseFloat(level) : 50; 
            if (battery > 75) {
                batteryIconEl.className = 'fas fa-battery-full fa-3x text-success';
            } else if (battery > 50) {
                batteryIconEl.className = 'fas fa-battery-three-quarters fa-3x text-success';
            } else if (battery > 25) {
                batteryIconEl.className = 'fas fa-battery-half fa-3x text-warning';
            } else {
                batteryIconEl.className = 'fas fa-battery-quarter fa-3x text-danger';
            }
        }

        function calculateSteps(pos1, pos2) {
            const R = 6371e3; // metres
            const φ1 = pos1.coords.latitude * Math.PI / 180;
            const φ2 = pos2.coords.latitude * Math.PI / 180;
            const Δφ = (pos2.coords.latitude - pos1.coords.latitude) * Math.PI / 180;
            const Δλ = (pos2.coords.longitude - pos1.coords.longitude) * Math.PI / 180;

            const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ/2) * Math.sin(Δλ/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            const distance = R * c;
            const steps = distance / 0.762;
            return Math.round(steps);
        }

        function sendLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        geolocationStatusEl.classList.add('d-none');
                        
                        if (lastPosition) {
                            const steps = calculateSteps(lastPosition, position);
                            totalSteps += steps;
                            stepCountEl.textContent = `${totalSteps} steps`;
                            stepsProgressEl.style.width = `${(totalSteps / 10000) * 100}%`;
                            if (totalSteps >= 7200) {
                                achievementTextEl.textContent = 'New badge: Super Explorer!';
                            }
                        }
                        lastPosition = position;

                        if (navigator.getBattery) {
                            navigator.getBattery().then(battery => {
                                const batteryLevel = `${Math.round(battery.level * 100)}%`;
                                batteryLevelEl.textContent = batteryLevel;
                                updateBatteryIcon(Math.round(battery.level * 100));
                                postLocation(position.coords.latitude, position.coords.longitude, batteryLevel);
                            });
                        } else {
                            postLocation(position.coords.latitude, position.coords.longitude, 'N/A');
                        }
                    },
                    (error) => {
                        console.error('Geolocation Error:', error);
                        geolocationStatusEl.classList.remove('d-none');
                        geolocationStatusEl.classList.add('alert-danger');
                        
                        if (error.code === 1) {
                            geolocationStatusEl.innerHTML = 'Please turn on your device\'s **Location** to share your position.';
                        } else {
                            geolocationStatusEl.innerHTML = 'There was a problem getting the location. Please try again.';
                        }
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                geolocationStatusEl.classList.remove('d-none');
                geolocationStatusEl.classList.add('alert-danger');
                geolocationStatusEl.innerHTML = 'Geolocation is not supported by your browser.';
            }
        }

        function postLocation(latitude, longitude, batteryLevel) {
            fetch(`/api/update_location/${childId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latitude: latitude,
                    longitude: longitude,
                    battery: batteryLevel
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    lastSeenEl.textContent = "Updated";
                } else {
                    console.error('Failed to send location:', data.message);
                }
            })
            .catch(error => {
                console.error('Network Error:', error);
            });
        }

        profilePictureUpload.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    profilePicturePreview.src = e.target.result;
                }
                reader.readAsDataURL(file);

                const formData = new FormData();
                formData.append('profile_picture', file);
                fetch('/api/upload_profile_picture', {
                    method: 'POST',
                    body: formData
                });
            }
        });

        setInterval(sendLocation, 10000); 
        sendLocation();
    });
</script>
{% endblock %}
