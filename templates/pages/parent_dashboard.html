<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Parent Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <style>
        #mapid {
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
    </style>
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('{{ url_for("static", filename="sw.js") }}')
                .then(reg => console.log('Service Worker registered', reg))
                .catch(err => console.log('Service Worker registration failed', err));
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>Welcome to your Dashboard, {{ username }}!</h1>
        <a href="{{ url_for('logout') }}" class="button">Logout</a>
        <br>
        <br>
        
        <div class="button-group">
            <a href="{{ url_for('geofence_page') }}" class="button">Manage Geofences</a>
        </div>

        <h2>Add a new child</h2>
        <form action="{{ url_for('add_child', username=username) }}" method="post">
            <input type="text" name="child_name" placeholder="Child's Name" required>
            <button type="submit">Add Child</button>
        </form>

        <h2>Your Children</h2>
        <div id="children-list">
            {% for child in children %}
            <div class="child-card">
                <p><strong>Name:</strong> {{ child.name }}</p>
                <p><strong>Pairing Code:</strong> **{{ child.pairing_code }}**</p>
                <form action="{{ url_for('refresh_pairing_code', child_id=child.id) }}" method="post" style="display:inline;">
                    <button type="submit" class="button">Refresh Code</button>
                </form>
            </div>
            {% endfor %}
        </div>
        
        <div id="mapid"></div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        var mymap;
        $(document).ready(function() {
            function updateChildrenData() {
                $.getJSON("/api/get_children_data", function(data) {
                    var childrenListHtml = '';
                    var mapMarkers = [];
                    data.children.forEach(function(child) {
                        childrenListHtml += `
                            <div class="child-card">
                                <p><strong>Name:</strong> ${child.name}</p>
                                <p><strong>Pairing Code:</strong> **${child.pairing_code}**</p>
                                <p><strong>Last Seen:</strong> ${child.last_seen ? new Date(child.last_seen).toLocaleString() : 'N/A'}</p>
                                ${child.phone_number ? `<a href="tel:${child.phone_number}" class="call-button">Call Child</a>` : ''}
                                <form action="/refresh_pairing_code/${child.id}" method="post" style="display:inline;">
                                    <button type="submit" class="button">Refresh Code</button>
                                </form>
                            </div>
                        `;
                        if (child.last_latitude && child.last_longitude) {
                            mapMarkers.push([child.last_latitude, child.last_longitude, child.name]);
                        }
                    });
                    $('#children-list').html(childrenListHtml);
                    
                    if (mymap) {
                        mymap.remove();
                    }
                    if (mapMarkers.length > 0) {
                        initializeMap(mapMarkers);
                    }
                });
            }

            updateChildrenData();
            setInterval(updateChildrenData, 10000);
        });

        function initializeMap(markers) {
            mymap = L.map('mapid').setView([markers[0][0], markers[0][1]], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(mymap);

            markers.forEach(marker => {
                L.marker([marker[0], marker[1]])
                    .addTo(mymap)
                    .bindPopup(`<b>${marker[2]}</b>'s Last Known Location`);
            });
        }
    </script>
</body>
</html>
